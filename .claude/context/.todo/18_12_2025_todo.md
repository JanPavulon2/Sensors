# Diuna Sprint Plan & Todos - 2025-12-18

## Status Summary

**Backend API**:  Working (CORS fixed, brightness conversion working)
**Frontend Display**:  Working (zones load, UI renders)
**Zone Updates**:   Partial (API works, state.json updates, but hardware doesn't render)
**Hardware LEDs**:  Broken (don't update unless zone selected, or require app restart)

---

## Critical Issues to Fix

### Issue 1: Hardware doesn't update for unselected zones
**Impact**: HIGH - Users can't edit all zones
**Status**: IDENTIFIED - Need to find selection filtering in render pipeline
**Files involved**:
- `src/controllers/led_controller/` (likely has selection check)
- `src/animations/engine.py` (zone iteration)
- `src/engine/frame_manager.py` (frame submission)

### Issue 2: Brightness changes invisible until restart
**Impact**: HIGH - No real-time feedback
**Status**: IDENTIFIED - Rendering loop doesn't respond to EventBus events
**Files involved**:
- `src/services/zone_service.py` (where to add listeners?)
- Animation controller files (need to subscribe to ZONE_STATE_CHANGED)

### Issue 3: Frontend port fluctuates (5173 vs 5175)
**Impact**: MEDIUM - Development friction
**Status**: EASY FIX - Add `strictPort: true`
**File**: `frontend/vite.config.ts`

---

## Investigation Tasks

- [ ] Find where zone selection filtering happens in hardware rendering
- [ ] Locate all EventBus subscribers for `ZONE_STATE_CHANGED` events
- [ ] Check if animation controller tasks listen to zone state changes
- [ ] Verify FrameManager submission happens for all zones, not just selected
- [ ] Look for async task patterns that might prevent updates from being processed
- [ ] Check if state is cached at startup and never updated

---

## Quick Wins (Do First)

### Task: Fix Vite Port (10 minutes)
**File**: `frontend/vite.config.ts`
**Current**:
```typescript
server: {
  port: 5173,
  host: true,
}
```

**Change to**:
```typescript
server: {
  port: 5173,
  strictPort: true,
  host: true,
}
```

**Test**:
- Kill process on 5173
- Start frontend
- Should either work on 5173 or fail with error message
- Not silently switch to 5174/5175

---

## Main Work (Priority Order)

### Priority 1: Fix Zone Rendering for Unselected Zones

**Objective**: Make all zone updates render to hardware immediately

**Steps**:
1. [ ] Find selection-based rendering gate
   - Search for `selected_zone` variable
   - Look in animation controller for filtering logic
   - Check FrameManager for zone-specific submissions

2. [ ] Understand why selection gates rendering
   - Is it intentional (performance)?
   - Is it a leftover from hardware UI development?
   - Should all zones always render?

3. [ ] Remove or bypass selection constraint
   - Make sure ALL zones get frames submitted
   - Test: Change unselected zone color ’ should update immediately

4. [ ] Verify selection still works for hardware control
   - Physical buttons should still control selected zone
   - Selection indicator should still show current zone
   - But API editing shouldn't require selection

---

### Priority 2: Subscribe Rendering to EventBus

**Objective**: Hardware re-renders when zone state changes

**Steps**:
1. [ ] Find where zones initially submit frames
   - Likely in animation controller startup
   - Where does first frame come from?

2. [ ] Add EventBus listener
   - Subscribe to `ZONE_STATE_CHANGED` events
   - Handler: Re-submit current frame with new state

3. [ ] Test brightness immediate update
   - Change brightness via API
   - Should see hardware change within 1 frame (16ms @ 60 FPS)
   - No restart needed

4. [ ] Test color immediate update
   - Change color via API
   - Should see hardware change immediately

---

### Priority 3: Allow Zone Editing Without Selection (Optional, but better UX)

**Objective**: Frontend allows editing any zone, selection only affects hardware control

**Steps**:
1. [ ] Identify where API editing is blocked
   - Is it frontend UI constraint?
   - Is it backend validation?

2. [ ] Allow all zones to be editable
   - Even if not selected, can change color/brightness
   - Selection indicator visible but doesn't block editing

3. [ ] Test free editing
   - Select FLOOR
   - Edit LAMP via UI (without selecting)
   - Should work without selecting first

---

### Priority 4: Simplify Brightness (Nice-to-have)

**Objective**: Remove 0-255 ” 0-100 conversion complexity

**Current**:
```
Frontend (0-255) ’ API converts ’ Domain (0-100) ’ Response converts ’ Frontend (0-255)
```

**Target**:
```
Frontend (0-100) ’ API (0-100) ’ Domain (0-100)
```

**Changes**:
1. [ ] Update API schema
   - `brightness: 0-100` not `0-255`
   - Remove conversion in API service

2. [ ] Update frontend slider
   - 0-100 scale (percentage)
   - No conversion needed

3. [ ] Test
   - Frontend slider at 50% ’ sends 50 ’ domain stores 50 ’ hardware gets 50

---

## Testing Checklist (After Each Fix)

**Test Suite 1: Unselected Zone Updates**
- [ ] Select FLOOR zone
- [ ] Change CIRCLE color via UI ’ circle updates immediately
- [ ] Change LAMP brightness via UI ’ lamp updates immediately
- [ ] No selection switching needed
- [ ] state.json changes saved
- [ ] EventBus logs show events

**Test Suite 2: Immediate Hardware Feedback**
- [ ] Change brightness value ’ LEDs change within frame time
- [ ] No restart needed to see changes
- [ ] Both selected and unselected zones work

**Test Suite 3: Port Consistency**
- [ ] Stop frontend
- [ ] Start frontend
- [ ] Should see port 5173 in logs (or clear error)
- [ ] Accessing localhost:5175 should fail (or redirect to 5173)

**Test Suite 4: Zone Editing Freedom**
- [ ] Can edit any zone without selecting it first
- [ ] Selection indicator still shows current hardware control zone
- [ ] Both independent

---

## Files to Read First (Investigation Phase)

1. `src/controllers/led_controller/animation_mode_controller.py` - Look for selection checks
2. `src/animations/engine.py` - Zone iteration and rendering
3. `src/engine/frame_manager.py` - Frame submission logic
4. `src/services/zone_service.py` - Zone state updates
5. `src/services/event_bus.py` - EventBus implementation
6. Any file containing `selected_zone` or `is_selected`

---

## Files to Modify (Implementation Phase)

**High Priority**:
- Animation controller (remove selection gate or add EventBus listener)
- Frame submission (ensure all zones get rendered)
- Event handling (add listener for ZONE_STATE_CHANGED)

**Medium Priority**:
- `frontend/vite.config.ts` (add strictPort)
- Zone API service (optional: simplify brightness)

---

## Success Metrics

After all fixes:
-  Can change any zone color/brightness from frontend
-  Hardware updates immediately (no restart needed)
-  Both selected and unselected zones render
-  Frontend always on port 5173
-  Selection indicator visible but doesn't restrict editing
-  EventBus events propagate to hardware rendering

---

## Estimated Effort

| Task | Effort | Dependencies |
|------|--------|--------------|
| Find selection gate | 30 min | - |
| Remove/bypass gate | 30 min | Investigation done |
| Add EventBus listener | 1 hour | Issue 1 done |
| Test extensively | 1 hour | Issues 1 & 2 done |
| Fix Vite port | 10 min | - |
| Simplify brightness | 30 min | Optional |

**Total**: ~3.5 hours for full fix (excluding simplification)

---

## Notes for Implementation

- Don't restart backend until all code changes done (to avoid needing restart twice)
- Test in Firefox DevTools to watch network requests and EventBus logs
- After fixing rendering, colors/brightness should change without restart
- Selection should still work for hardware, just not block editing
